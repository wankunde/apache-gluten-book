# ================================================================
# Apache Gluten - Velox 后端完整配置模板
# ================================================================
# 
# 功能：Velox 后端的所有关键配置参数
# 相关章节：第11章 - Velox 后端
# 
# 使用方式：
# spark-submit \
#   --properties-file velox-config.conf \
#   your-application.jar
#
# 或在代码中：
# spark = SparkSession.builder.config(conf=SparkConf().setAll(...))
# ================================================================

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 1. Gluten 核心配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 启用 Gluten 插件
spark.plugins=org.apache.gluten.GlutenPlugin

# 启用 Gluten SQL 扩展
spark.gluten.enabled=true

# 选择 Velox 后端
spark.gluten.sql.columnar.backend.lib=velox

# Velox 库路径（根据实际安装路径修改）
spark.gluten.sql.columnar.backend.velox.home=/usr/local/velox

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 2. 内存配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Executor 内存
spark.executor.memory=8g

# Off-Heap 内存（Velox 使用）
spark.memory.offHeap.enabled=true
spark.memory.offHeap.size=5g

# 内存开销（用于 Native 内存）
spark.executor.memoryOverhead=2g

# Gluten 内存分配器
spark.gluten.memory.allocator=velox

# Velox 内存池配置
spark.gluten.sql.columnar.backend.velox.memoryPoolInitialCapacity=1073741824  # 1GB
spark.gluten.sql.columnar.backend.velox.memoryPoolCapacityGrowthPct=25

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 3. Velox 执行配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Velox 线程数（通常设置为 CPU 核心数）
spark.gluten.sql.columnar.backend.velox.numThreads=8

# 批处理大小
spark.gluten.sql.columnar.batchSize=4096

# 向量化读取
spark.gluten.sql.columnar.vectorizedReaderEnabled=true

# WholeStage 代码生成
spark.gluten.sql.columnar.wholeStageEnabled=true

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 4. Columnar Shuffle 配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 启用 Columnar Shuffle
spark.shuffle.manager=org.apache.spark.shuffle.sort.ColumnarShuffleManager

# Columnar Shuffle 压缩
spark.gluten.sql.columnar.shuffle.codec=lz4

# Shuffle 分区数
spark.sql.shuffle.partitions=200

# 单个 Shuffle 分区的最大大小
spark.sql.files.maxPartitionBytes=134217728  # 128MB

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 5. Velox Cache 配置（可选）
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 启用 Velox File Cache
spark.gluten.sql.columnar.backend.velox.cacheEnabled=true

# Cache 大小
spark.gluten.sql.columnar.backend.velox.cacheSize=10737418240  # 10GB

# Cache 路径（使用 SSD）
spark.gluten.sql.columnar.backend.velox.cachePath=/mnt/ssd/velox-cache

# Cache 页面大小
spark.gluten.sql.columnar.backend.velox.cachePageSize=1048576  # 1MB

# Cache 淘汰策略（LRU）
spark.gluten.sql.columnar.backend.velox.cacheEvictionPolicy=LRU

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 6. 数据源配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Parquet 读取配置
spark.sql.parquet.enableVectorizedReader=true
spark.sql.parquet.columnarReaderBatchSize=4096

# ORC 读取配置
spark.sql.orc.enableVectorizedReader=true
spark.sql.orc.columnarReaderBatchSize=4096

# 文件格式优先使用列式
spark.gluten.sql.columnar.filescan.enabled=true

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 7. 优化器配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 启用自适应查询执行（AQE）
spark.sql.adaptive.enabled=true
spark.sql.adaptive.coalescePartitions.enabled=true
spark.sql.adaptive.skewJoin.enabled=true

# Cost-based 优化
spark.sql.cbo.enabled=true
spark.sql.cbo.joinReorder.enabled=true

# 动态分区裁剪
spark.sql.optimizer.dynamicPartitionPruning.enabled=true

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 8. Fallback 控制
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Fallback 策略
# - "AUTO": 自动 Fallback（推荐）
# - "FORCE": 强制使用 Gluten，不支持的算子会报错
# - "DISABLE": 禁用 Gluten
spark.gluten.sql.columnar.fallback.mode=AUTO

# 记录 Fallback 原因
spark.gluten.sql.columnar.fallback.reportEnabled=true

# Fallback 原因日志级别
spark.gluten.sql.columnar.fallback.logLevel=WARN

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 9. Velox 特定函数配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 启用 Velox 表达式评估
spark.gluten.sql.columnar.backend.velox.expressionEvaluatorEnabled=true

# 启用 Velox 聚合函数
spark.gluten.sql.columnar.backend.velox.aggregateFunctionEnabled=true

# 启用 Velox 窗口函数
spark.gluten.sql.columnar.backend.velox.windowFunctionEnabled=true

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 10. 调试和监控
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 启用 Gluten Metrics
spark.gluten.sql.columnar.metrics.enabled=true

# 打印执行计划
spark.sql.planChangeLog.level=INFO

# 日志级别
spark.gluten.logLevel=INFO

# 启用执行时间追踪
spark.gluten.sql.columnar.backend.velox.timingEnabled=true

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 11. 性能调优
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Broadcast Join 阈值
spark.sql.autoBroadcastJoinThreshold=104857600  # 100MB

# 并行度
spark.default.parallelism=200

# Executor 核心数
spark.executor.cores=4

# Executor 实例数
spark.executor.instances=10

# Task 内存
spark.task.maxDirectResultSize=1g

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 12. 生产环境推荐配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 启用事件日志
spark.eventLog.enabled=true
spark.eventLog.dir=hdfs:///spark-logs

# 启用动态资源分配
spark.dynamicAllocation.enabled=true
spark.dynamicAllocation.minExecutors=5
spark.dynamicAllocation.maxExecutors=50
spark.dynamicAllocation.initialExecutors=10

# Speculation（推测执行）
spark.speculation=true
spark.speculation.multiplier=2

# 序列化
spark.serializer=org.apache.spark.serializer.KryoSerializer
spark.kryoserializer.buffer.max=128m

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 配置说明
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# 小型集群（<10 节点）:
#   - executor.memory: 4-8g
#   - offHeap.size: 2-5g
#   - executor.instances: 5-10
#
# 中型集群（10-50 节点）:
#   - executor.memory: 8-16g
#   - offHeap.size: 5-10g
#   - executor.instances: 10-30
#
# 大型集群（>50 节点）:
#   - executor.memory: 16-32g
#   - offHeap.size: 10-20g
#   - executor.instances: 30-100
#
# 调优建议：
#   1. Off-Heap 内存通常设置为 Executor 内存的 60-70%
#   2. Velox Cache 大小根据热数据量设置，建议 10-50GB
#   3. 线程数设置为 CPU 核心数
#   4. Shuffle 分区数约为 executor 总核心数的 2-3 倍
# ================================================================
