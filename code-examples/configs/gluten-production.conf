# 生产环境配置模板
# 用途：适用于生产环境的完整配置

# ========== Gluten 核心配置 ==========
spark.plugins                               org.apache.gluten.GlutenPlugin
spark.gluten.enabled                        true

# ========== 内存配置 ==========
spark.memory.offHeap.enabled                true
spark.memory.offHeap.size                   30g
spark.gluten.memory.isolation               true
spark.gluten.memory.reservationBlockSize    8MB
spark.gluten.memory.overAcquiredMemoryRatio 0.3

# ========== Shuffle 配置 ==========
spark.shuffle.manager                       org.apache.spark.shuffle.sort.ColumnarShuffleManager
spark.gluten.shuffleWriter.bufferSize       4m

# ========== ClassPath 配置 ==========
spark.driver.extraClassPath                 /opt/gluten/gluten-velox-bundle-spark3.3_2.12-1.2.0.jar
spark.executor.extraClassPath               /opt/gluten/gluten-velox-bundle-spark3.3_2.12-1.2.0.jar

# ========== 自适应查询执行 ==========
spark.sql.adaptive.enabled                  true
spark.sql.adaptive.coalescePartitions.enabled true
spark.sql.adaptive.coalescePartitions.minPartitionSize 1MB
spark.sql.adaptive.skewJoin.enabled         true
spark.sql.adaptive.localShuffleReader.enabled true

# ========== Columnar 执行 ==========
spark.gluten.sql.columnar.batchscan         true
spark.gluten.sql.columnar.filter            true
spark.gluten.sql.columnar.project           true
spark.gluten.sql.columnar.hashagg           true
spark.gluten.sql.columnar.broadcastJoin     true
spark.gluten.sql.columnar.broadcastExchange true
spark.gluten.sql.columnar.filescan          true

# ========== Fallback 配置 ==========
spark.gluten.sql.columnar.fallback.preferColumnar true
spark.gluten.sql.columnar.fallback.ignoreRowToColumnar true

# ========== Velox 后端配置 ==========
# 内存管理
spark.gluten.sql.columnar.backend.velox.memInitCapacity 8MB
spark.gluten.sql.columnar.backend.velox.memoryPoolCapacityTransferAcrossTasks true

# Spill 配置
spark.gluten.sql.columnar.backend.velox.spillStrategy auto
spark.gluten.sql.columnar.backend.velox.spillFileSystem local
spark.gluten.sql.columnar.backend.velox.maxSpillFileSize 1GB
spark.gluten.sql.columnar.backend.velox.maxSpillBytes 100GB

# 文件读取优化
spark.gluten.sql.columnar.backend.velox.maxCoalescedBytes 64MB
spark.gluten.sql.columnar.backend.velox.maxCoalescedDistance 512KB
spark.gluten.sql.columnar.backend.velox.loadQuantum 256MB
spark.gluten.sql.columnar.backend.velox.prefetchRowGroups 1

# 聚合优化
spark.gluten.sql.columnar.backend.velox.flushablePartialAggregation true
spark.gluten.sql.columnar.backend.velox.maxPartialAggregationMemoryRatio 0.1
spark.gluten.sql.columnar.backend.velox.abandonPartialAggregationMinRows 100000

# Shuffle 优化
spark.gluten.sql.columnar.backend.velox.resizeBatches.shuffleInput true

# ========== Executor 配置 ==========
spark.executor.instances                    20
spark.executor.cores                        8
spark.executor.memory                       48g
spark.executor.memoryOverhead               8g

# ========== Driver 配置 ==========
spark.driver.memory                         8g
spark.driver.cores                          4

# ========== 动态资源分配 ==========
spark.dynamicAllocation.enabled             true
spark.dynamicAllocation.minExecutors        10
spark.dynamicAllocation.maxExecutors        50
spark.dynamicAllocation.initialExecutors    20

# ========== 其他优化 ==========
spark.sql.shuffle.partitions                400
spark.sql.files.maxPartitionBytes           128MB
spark.sql.autoBroadcastJoinThreshold        10MB

# ========== 监控和日志 ==========
spark.gluten.ui.enabled                     true
spark.eventLog.enabled                      true
spark.eventLog.dir                          hdfs:///spark-logs
