# ================================================================
# Apache Gluten - ClickHouse 后端完整配置模板
# ================================================================
#
# 功能：ClickHouse 后端的所有关键配置参数
# 相关章节：第12章 - ClickHouse 后端
#
# 使用方式：
# spark-submit \
#   --properties-file clickhouse-config.conf \
#   your-application.jar
# ================================================================

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 1. Gluten 核心配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 启用 Gluten 插件
spark.plugins=org.apache.gluten.GlutenPlugin

# 启用 Gluten
spark.gluten.enabled=true

# 选择 ClickHouse 后端
spark.gluten.sql.columnar.backend.lib=clickhouse

# ClickHouse 库路径
spark.gluten.sql.columnar.backend.ch.home=/usr/local/clickhouse

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 2. 内存配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Executor 内存
spark.executor.memory=8g

# Off-Heap 内存
spark.memory.offHeap.enabled=true
spark.memory.offHeap.size=5g

# 内存开销
spark.executor.memoryOverhead=2g

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 3. ClickHouse 执行配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 线程数
spark.gluten.sql.columnar.backend.ch.threads=8

# 批处理大小
spark.gluten.sql.columnar.batchSize=4096

# 启用向量化
spark.gluten.sql.columnar.vectorizedReaderEnabled=true

# 使用 v2 选择构建
spark.gluten.sql.columnar.backend.ch.use.v2.select.build=true

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 4. ClickHouse 运行时设置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 首选本地执行计划
spark.gluten.sql.columnar.backend.ch.runtime_settings.prefer_local_plan=true

# 最大线程数
spark.gluten.sql.columnar.backend.ch.runtime_settings.max_threads=8

# 聚合内存限制
spark.gluten.sql.columnar.backend.ch.runtime_settings.max_bytes_before_external_group_by=10737418240  # 10GB

# Join 内存限制
spark.gluten.sql.columnar.backend.ch.runtime_settings.max_bytes_in_join=10737418240  # 10GB

# 排序内存限制
spark.gluten.sql.columnar.backend.ch.runtime_settings.max_bytes_before_external_sort=10737418240  # 10GB

# 读取缓冲区大小
spark.gluten.sql.columnar.backend.ch.runtime_settings.max_read_buffer_size=10485760  # 10MB

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 5. Columnar Shuffle 配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 启用 Columnar Shuffle
spark.shuffle.manager=org.apache.spark.shuffle.sort.ColumnarShuffleManager

# Shuffle 压缩
spark.gluten.sql.columnar.shuffle.codec=lz4

# Shuffle 分区数
spark.sql.shuffle.partitions=200

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 6. 数据源配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Parquet 配置
spark.sql.parquet.enableVectorizedReader=true
spark.sql.parquet.columnarReaderBatchSize=4096

# 文件扫描
spark.gluten.sql.columnar.filescan.enabled=true

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 7. 优化器配置
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 自适应查询执行
spark.sql.adaptive.enabled=true
spark.sql.adaptive.coalescePartitions.enabled=true
spark.sql.adaptive.skewJoin.enabled=true

# Cost-based 优化
spark.sql.cbo.enabled=true

# 动态分区裁剪
spark.sql.optimizer.dynamicPartitionPruning.enabled=true

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 8. ClickHouse 特定优化
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 启用表达式下推
spark.gluten.sql.columnar.backend.ch.expression.pushdown.enabled=true

# 启用谓词下推
spark.gluten.sql.columnar.backend.ch.predicate.pushdown.enabled=true

# 启用列裁剪
spark.gluten.sql.columnar.backend.ch.column.pruning.enabled=true

# 启用聚合下推
spark.gluten.sql.columnar.backend.ch.aggregate.pushdown.enabled=true

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 9. Fallback 控制
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Fallback 模式
spark.gluten.sql.columnar.fallback.mode=AUTO

# 记录 Fallback
spark.gluten.sql.columnar.fallback.reportEnabled=true

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 10. 性能调优
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Broadcast Join 阈值
spark.sql.autoBroadcastJoinThreshold=104857600  # 100MB

# 并行度
spark.default.parallelism=200

# Executor 配置
spark.executor.cores=4
spark.executor.instances=10

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 11. 监控和调试
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 启用 Metrics
spark.gluten.sql.columnar.metrics.enabled=true

# 日志级别
spark.gluten.logLevel=INFO

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 配置建议
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# ClickHouse vs Velox 选择：
# 
# 使用 ClickHouse 后端的场景：
#   • 需要更多的 SQL 函数支持（1000+ 函数）
#   • 字符串处理密集型任务
#   • 复杂的聚合查询
#   • 需要特定的 ClickHouse 函数
#
# 使用 Velox 后端的场景：
#   • 通用数据处理任务
#   • 与 Presto/Facebook 生态集成
#   • 更成熟的社区支持
#
# 内存配置：
#   • ClickHouse 对内存要求较高
#   • 建议 Off-Heap 至少 4GB
#   • 大型聚合建议 8GB+
# ================================================================
